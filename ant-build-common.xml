<project name="build-common"  xmlns:antcontrib="antlib:net.sf.antcontrib" >
	<!-- Ignore the classpath from the shell running ant.  This avoids dependency
      on the user's environment and suppresses the warning about includeAntRuntime. -->
	<property name="build.sysclasspath" value="ignore"/>
	<!-- Java -->
	<property name="javac.target" value="11"/>
	<!-- Standard directory paths -->
	<property name="src.dir" location="src"/>
	<property name="src.java.dir" location="src/java"/>
	<property name="src.bin.dir" location="src/bin"/>
	<property name="src.libexec.dir" location="src/libexec"/>
	<property name="src.zimlet.dir" location="src/zimlet"/>
	<property name="jars.dir" location="jars"/>
	<property name="build.dir" location="target"/>
	<property name="build.tmp.dir" location="${build.dir}/tmp"/>
	<property name="dist.dir" location="${build.dir}/dist"/>
	<property name="dist.lib.dir" location="${dist.dir}/lib"/>
	<property name="dist.lib.ext.dir" location="${dist.lib.dir}/ext"/>
	<property name="build.classes.dir" location="${build.dir}/classes"/>
	<property name="build.instrumented.dir" location="${build.dir}/classes-inst"/>
	<property name="build.zimlet.dir" location="${build.dir}/zimlet"/>
	<!-- Standard install paths -->
	<property name="zimbra.home.dir" location="/opt/zextras"/>
	<property name="jetty.home.dir" location="${zimbra.home.dir}/jetty"/>
	<property name="jetty.webapps.dir" location="${jetty.home.dir}/webapps"/>
	<property name="common.jars.dir" location="${zimbra.home.dir}/lib/jars"/>
	<property name="jetty.endorsed.jars.dir" location="${jetty.home.dir}/common/endorsed"/>
	<property name="jetty.common.jars.dir" location="${jetty.home.dir}/common/lib"/>
	<property name="ext-common.jars.dir" location="${zimbra.home.dir}/lib/ext-common"/>
	<property name="common.sourcejars.dir" location="${zimbra.home.dir}/jars-src"/>
	<!-- ZimbraCommon -->
	<property name="common.dir" location="${zm-mailbox.basedir}/common"/>
	<property name="common.src.java.dir" location="${common.dir}/src/java"/>
	<property name="common.classes.dir" location="${common.dir}/build/classes"/>
	<property name="common.jarfile" location="${common.dir}/build/zimbracommon.jar"/>
	<property name="common.internal.jars.dir" location="../jars-internal/jars"/>
	<!-- ZimbraNative -->
	<property name="native.dir" location="${zm-mailbox.basedir}/native"/>
	<property name="native.classes.dir" location="${native.dir}/build/classes"/>
	<!-- ZimbraServer -->
	<property name="server.dir" location="${zm-mailbox.basedir}/store"/>
	<property name="server.classes.dir" location="${server.dir}/build/classes"/>
	<property name="server.test.classes.dir" location="${server.dir}/build/test-classes"/>
	<property name="server.jarfile" location="${server.dir}/build/zimbrastore.jar"/>
	<property name="server.jars.dir" location="${zimbra.home.dir}/jars"/>
	<property name="server.conf.dir" location="${server.dir}/conf"/>
	<!-- ZimbraSoap -->
	<property name="soap.dir" location="${zm-mailbox.basedir}/soap"/>
	<property name="soap.classes.dir" location="${soap.dir}/build/classes"/>
	<property name="soap.jarfile" location="${soap.dir}/build/zimbrasoap.jar"/>
	<!-- ZimbraClient -->
	<property name="client.dir" location="${zm-mailbox.basedir}/client"/>
	<property name="client.classes.dir" location="${client.dir}/build/classes"/>
	<property name="client.jarfile" location="${client.dir}/build/zimbraclient.jar"/>
	<property name="msgs.dir" location="${zm-mailbox.basedir}/store-conf/conf/msgs"/>

	<target name="carbonio-version">
		<fail
      message="Missing build version. use ant proper ZCS version like -Dcarbonio.buildinfo.version=22.00.0_ZEXTRAS_202211">
			<condition>
				<not>
					<isset property="carbonio.buildinfo.version"/>
				</not>
			</condition>
		</fail>
	</target>

	<target depends="carbonio-version" name="require-version">
		<echo message="Using version ${zimbra.buildinfo.version}"/>
		<property name="zimbra.buildinfo.version" value="${carbonio.buildinfo.version}"/>
	</target>

	<target name="set-dev-version" depends="require-version">
		<antcontrib:if>
			<not>
				<isset property="jar.file"/>
			</not>
			<then>
				<exec executable="git" outputproperty="git.timestamp">
					<arg value="log"/>
					<arg value="-1"/>
					<arg value="--pretty=format:%at"/>
				</exec>
				<!-- Build version -->
				<tstamp/>
				<antcontrib:propertyregex property="zimbra.buildinfo.majorversion"
          input="${zimbra.buildinfo.version}" regexp="([0-9]+)\.([0-9]+)\.([0-9]+)" select="\1"
          casesensitive="false"/>
				<antcontrib:propertyregex property="zimbra.buildinfo.minorversion"
          input="${zimbra.buildinfo.version}" regexp="([0-9]+)\.([0-9]+)\.([0-9]+)" select="\2"
          casesensitive="false"/>
				<antcontrib:propertyregex property="zimbra.buildinfo.microversion"
          input="${zimbra.buildinfo.version}" regexp="([0-9]+)\.([0-9]+)\.([0-9]+)" select="\3"
          casesensitive="false"/>
				<antcontrib:propertyregex property="zimbra.buildinfo.relclass" defaultValue="GA"
          input="${zimbra.buildinfo.version}" regexp="([0-9]+)\.([0-9]+)\.([0-9]+)_([A-Z]+)"
          select="\4" casesensitive="false"/>
				<antcontrib:propertyregex property="zimbra.buildinfo.buildnum"
          input="${zimbra.buildinfo.version}"
          regexp="([0-9]+)\.([0-9]+)\.([0-9]+)_([A-Z]+)_([0-9]+)" select="\5"
          casesensitive="false"/>
				<condition property="zimbra.buildinfo.relnum" value="0">
					<not>
						<isset property="${zimbra.buildinfo.relnum}"/>
					</not>
				</condition>
				<condition property="zimbra.buildinfo.type" value="">
					<not>
						<isset property="${zimbra.buildinfo.type}"/>
					</not>
				</condition>
				<condition property="zimbra.buildinfo.release" value="${user.name}">
					<not>
						<isset property="${zimbra.buildinfo.release}"/>
					</not>
				</condition>
				<condition property="zimbra.buildinfo.date" value="${DSTAMP}-${TSTAMP}">
					<not>
						<isset property="${zimbra.buildinfo.date}"/>
					</not>
				</condition>
				<condition property="zimbra.buildinfo.host" value="${zimbra.server.hostname}">
					<not>
						<isset property="${zimbra.buildinfo.host}"/>
					</not>
				</condition>
				<property name="zimbra.buildinfo.microtag"
          value="${zimbra.buildinfo.microversion}_${zimbra.buildinfo.relclass}"/>
				<property name="zimbra.buildinfo.all"
          value="Version: ${zimbra.buildinfo.version}; Type: ${zimbra.buildinfo.type}; Release: ${zimbra.buildinfo.release}; Built: ${zimbra.buildinfo.date}; Host: ${zimbra.buildinfo.host}"/>
				<property name="dev.version"
          value="${zimbra.buildinfo.majorversion}.${zimbra.buildinfo.minorversion}.${zimbra.buildinfo.microversion}"/>
				<property name="jar.file" value="${ant.project.name}-${dev.version}.jar"/>
			</then>
		</antcontrib:if>
	</target>
</project>
