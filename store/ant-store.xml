<project name="zm-store">
  <import file="../ant-build-common.xml"/>

  <property name="service.webapp.dir" location="${jetty.webapps.dir}/service"/>
  <property name="zimbra.webapp.dir" location="${jetty.webapps.dir}/zimbra"/>
  <property name="admin.webapp.dir" location="${jetty.webapps.dir}/zimbraAdmin"/>
  <property name="conf.dir" location="conf"/>
  <property name="store-conf.config.dir" location="${basedir}/../store-conf/conf"/>

  <!-- LDAP -->
  <property name="attrs.dir" location="${conf.dir}/attrs"/>
  <property name="ldap.dir" location="${basedir}/ldap"/>
  <property name="ldap.conf.dir" location="${ldap.dir}/conf"/>
  <property name="slapd.config.dir" value="${ldap.conf.dir}/ldap/config" />
  <property name="slapd.config.src" value="${slapd.config.dir}/cn=config.ldif"/>
  <property name="ldap.build.dir" value="${basedir}/build/ldap"/>

  <condition property="production.suffix" value=".production" else="">
    <isset property="is-production"/>
  </condition>
  <condition property="war.web.xml" value="${conf.dir}/web.xml${production.suffix}">
    <not>
      <isset property="war.web.xml"/>
    </not>
  </condition>

  <target name="generate-sources"
    depends="generate-buildinfo, generate-getters,generate-rights, create-version-sql,create-version-ldap ">
  </target>

  <!--  TODO: remove unnecessary folder-->
  <target name="build-init" description="Creates directories required for compiling">
    <mkdir dir="${build.classes.dir}"/>
    <mkdir dir="${maven.build.dir}/data"/>
    <mkdir dir="${maven.build.dir}/zimbra"/>
    <mkdir dir="${maven.build.dir}/zimbra/conf"/>
    <mkdir dir="${maven.build.dir}/bin"/>
    <mkdir dir="${maven.build.dir}/conf/attrs"/>
    <mkdir dir="${maven.build.dir}/conf/msgs"/>
    <mkdir dir="${maven.build.dir}/db"/>
    <mkdir dir="${maven.build.dir}/lib/ext"/>
    <mkdir dir="${maven.build.dir}/lib/jars"/>
    <mkdir dir="${maven.build.dir}/lib/jars-ant"/>
    <mkdir dir="${maven.build.dir}/libexec"/>
  </target>

  <target name="generate-buildinfo" depends="build-init, set-dev-version">
    <mkdir dir="${maven.build.dir}/buildinfo/com/zimbra/cs/util"/>
    <echo file="${maven.build.dir}/buildinfo/com/zimbra/cs/util/BuildInfoGenerated.java">
      package com.zimbra.cs.util;

      class BuildInfoGenerated {
      public static final String MAJORVERSION = "${zimbra.buildinfo.majorversion}";
      public static final String MINORVERSION = "${zimbra.buildinfo.minorversion}";
      public static final String MICROVERSION = "${zimbra.buildinfo.microversion}";
      public static final String RELCLASS = "${zimbra.buildinfo.relclass}";
      public static final String RELNUM = "${zimbra.buildinfo.relnum}";
      public static final String BUILDNUM = "${zimbra.buildinfo.buildnum}";
      public static final String VERSION = "${zimbra.buildinfo.version}";
      public static final String RELEASE = "${zimbra.buildinfo.release}";
      public static final String DATE = "${DSTAMP}-${TSTAMP}";
      public static final String HOST = "${zimbra.buildinfo.host}";
      }
    </echo>
    <javac includeantruntime="false" destdir="${build.classes.dir}"
      target="${javac.target}" srcdir="${maven.build.dir}/buildinfo">
      <compilerarg value="-Xlint:deprecation"/>
      <compilerarg value="-Xlint:unchecked"/>
    </javac>
  </target>

  <!-- Cleans up store directory and maven build in maven clean phase -->
  <target name="clean">
    <delete dir="${basedir}/build"/>
    <delete dir="${basedir}/tmp"/>
    <delete dir="${maven.build.dir}"/>
  </target>

  <!-- Copies bundle msgs required for test to directory base folder -->
  <target name="copy-msgs-bundle">
    <copy todir="${basedir}/build/zimbra/conf/msgs">
      <fileset dir="${basedir}/../store-conf/conf/msgs"/>
    </copy>
    <copy todir="${basedir}/build/zimbra/conf/" file="${basedir}/../store-conf/conf/log4j.properties"/>
    <copy todir="${basedir}/build/zimbra/conf/" file="${basedir}/../store-conf/conf/antisamy.xml"/>
    <copy todir="${basedir}/build/zimbra/conf/" file="${basedir}/../store-conf/conf/owasp_policy.xml"/>
    <copy todir="${basedir}/build/zimbra/conf/" file="${basedir}/../store-conf/conf/contacts/contact-fields.xml"/>
  </target>

  <target name="generate-getters" description="generate methods for attributes in attrs.xml">
    <antcall target="generate-getter">
      <param name="getter.class" value="account"/>
      <param name="getter.output" value="ZAttrAccount.java"/>
    </antcall>
    <antcall target="generate-getter">
      <param name="getter.class" value="calendarResource"/>
      <param name="getter.output" value="ZAttrCalendarResource.java"/>
    </antcall>
    <antcall target="generate-getter">
      <param name="getter.class" value="server"/>
      <param name="getter.output" value="ZAttrServer.java"/>
    </antcall>
    <antcall target="generate-getter">
      <param name="getter.class" value="distributionList"/>
      <param name="getter.output" value="ZAttrDistributionList.java"/>
    </antcall>
    <antcall target="generate-getter">
      <param name="getter.class" value="group"/>
      <param name="getter.output" value="ZAttrDynamicGroup.java"/>
    </antcall>
    <antcall target="generate-getter">
      <param name="getter.class" value="shareLocator"/>
      <param name="getter.output" value="ZAttrShareLocator.java"/>
    </antcall>
    <antcall target="generate-provisioning"/>
  </target>

  <target name="generate-getter">
    <java classname="com.zimbra.cs.account.AttributeManagerUtil" fork="true"
      classpath="${maven_compile_classpath}" failonerror="true">
      <sysproperty key="carbonio.version" value="${carbonio.buildinfo.all}"/>
      <arg
        line="-a generateGetters -c ${getter.class} -i ${attrs.dir} -r ${src.java.dir}/com/zimbra/cs/account/${getter.output}"/>
    </java>
  </target>
  <target name="generate-provisioning">
    <java classname="com.zimbra.cs.account.AttributeManagerUtil" fork="true"
      classpath="${maven_compile_classpath}" failonerror="true">
      <sysproperty key="carbonio.version" value="${carbonio.buildinfo.all}"/>
      <arg
        line="-a generateProvisioning -i ${attrs.dir} -r ${common.src.java.dir}/com/zimbra/common/account/ZAttrProvisioning.java"/>
    </java>
  </target>

  <target name="create-version-sql" depends="build-init, set-dev-version"
    description="Creates version-init.sql">
    <java classname="com.zimbra.cs.db.MySQL" fork="true" classpath="${maven_compile_classpath}"
      failonerror="true">
      <classpath>
        <pathelement location="${maven.build.dir}/classes"/>
      </classpath>
      <arg line="-o ${maven.build.dir}"/>
    </java>
  </target>

  <target name="create-version-ldap" depends="build-init"
    description="Creates ldap schema version: attrs-schema">
    <exec executable="git" failonerror="false" output="${maven.build.dir}/conf/attrs/attrs-schema">
      <arg value="log"/>
      <arg value="-1"/>
      <arg value="--pretty=format:%at"/>
      <arg value="conf/attrs/attrs.xml"/>
    </exec>
  </target>

  <!-- Rights generator -->
  <path id="class.path">
    <pathelement path="${maven_compile_classpath}"/>
    <pathelement path="src/main/java"/>
  </path>

  <target name="generate-domainadmin-rights-xml">
    <java classname="com.zimbra.cs.account.accesscontrol.RightManager" classpathref="class.path"  fork="true" failonerror="true">
      <sysproperty key="carbonio.version" value="${carbonio.buildinfo.all}"/>
      <sysproperty key="zimbra.config" value="conf/localconfig-autogen.xml"/>
      <arg line="-a genDomainAdminSetAttrsRights -r ${store-conf.config.dir}/rights/rights-domainadmin.xml -t ${store-conf.config.dir}/rights/rights-domainadmin.xml-template"/>
    </java>
  </target>

  <target name="generate-rights-java">
    <java classname="com.zimbra.cs.account.accesscontrol.RightManager" fork="true" classpathref="class.path" failonerror="true">
      <sysproperty key="zimbra.config" value="conf/localconfig-autogen.xml"/>
      <sysproperty key="carbonio.version" value="${carbonio.buildinfo.all}"/>
      <arg line="-a genRightConsts -i ${store-conf.config.dir}/rights -r
      ${src.java.dir}/com/zimbra/cs/account/accesscontrol/generated/RightConsts.java"/>
    </java>
    <java classname="com.zimbra.cs.account.accesscontrol.RightManager" fork="true" classpathref="class.path" failonerror="true">
      <sysproperty key="zimbra.config" value="conf/localconfig-autogen.xml"/>
      <sysproperty key="carbonio.version" value="${carbonio.buildinfo.all}"/>
      <arg line="-a genAdminRights -i ${store-conf.config.dir}/rights -r ${src.java.dir}/com/zimbra/cs/account/accesscontrol/generated/AdminRights.java"/>
    </java>
    <java classname="com.zimbra.cs.account.accesscontrol.RightManager" fork="true" classpathref="class.path" failonerror="true">
      <sysproperty key="zimbra.config" value="conf/localconfig-autogen.xml"/>
      <sysproperty key="carbonio.version" value="${carbonio.buildinfo.all}"/>
      <arg line="-a genUserRights -i ${store-conf.config.dir}/rights -r ${src.java.dir}/com/zimbra/cs/account/accesscontrol/generated/UserRights.java"/>
    </java>
  </target>

  <target name="generate-rights-message-properties">
    <java classname="com.zimbra.cs.account.accesscontrol.RightManager" fork="true" classpathref="class.path" failonerror="true">
      <sysproperty key="carbonio.version" value="${carbonio.buildinfo.all}"/>
      <sysproperty key="zimbra.config" value="conf/localconfig-autogen.xml"/>
      <arg line="-a genMessageProperties -i ${store-conf.config.dir}/rights -r ${store-conf.config.dir}/msgs/ZsMsgRights.properties"/>
    </java>
  </target>

  <target name="generate-rights">
    <antcall target="generate-domainadmin-rights-xml"/>
    <antcall target="generate-rights-java"/>
    <antcall target="generate-rights-message-properties"/>
  </target>

  <!-- LDAP schema generation -->
  <target name="generate-ldap-config">
    <dependset>
      <srcfileset dir="${attrs.dir}" includes="*.xml" />
      <targetfileset dir="${maven.build.dir}/ldap-config" includes="*" />
    </dependset>

    <mkdir dir="${maven.build.dir}/attrs"/>
    <copy todir="${maven.build.dir}/attrs" overwrite="true" preservelastmodified="true">
      <fileset dir="${attrs.dir}" includes="*.xml" />
    </copy>
    <mkdir dir="${maven.build.dir}/ldap-config" />
    <mkdir dir="${ldap.build.dir}/config" />
    <mkdir dir="${ldap.build.dir}/schema" />
    <mkdir dir="${ldap.build.dir}/config/cn=config" />
    <!-- Schema for pre OpenLDAP 2.4 - uses carbonio.schema-template, should eventually retire carbonio.schema-template and only use ocs.xml -->
    <java classname="com.zimbra.cs.account.AttributeManagerUtil" fork="true" classpathref="class.path" failonerror="true">
      <sysproperty key="carbonio.version" value="${carbonio.buildinfo.all}" />
      <arg line="-a generateLdapSchema -i ${maven.build.dir}/attrs -t ${ldap.conf.dir}/ldap/carbonio.schema-template -o ${ldap.build.dir}/schema/carbonio.schema" />
    </java>
    <!-- Zimbra schema for OpenLDAP 2.4 - use ocs.xml -->
    <java classname="com.zimbra.cs.account.AttributeManagerUtil" fork="true" classpathref="class.path" failonerror="true">
      <sysproperty key="carbonio.version" value="${carbonio.buildinfo.all}" />
      <arg line="-a generateSchemaLdif -i ${maven.build.dir}/attrs -o ${ldap.build.dir}/schema/carbonio.ldif" />
    </java>
    <java classname="com.zimbra.cs.account.AttributeManagerUtil" fork="true" classpathref="class.path" failonerror="true">
      <sysproperty key="carbonio.version" value="${carbonio.buildinfo.all}" />
      <arg line="-a generateGlobalConfigLdif -i ${maven.build.dir}/attrs -o ${ldap.build.dir}/zimbra_globalconfig.ldif" />
    </java>
    <java classname="com.zimbra.cs.account.AttributeManagerUtil" fork="true" classpathref="class.path" failonerror="true">
      <sysproperty key="carbonio.version" value="${carbonio.buildinfo.all}" />
      <arg line="-a generateDefaultCOSLdif -i ${maven.build.dir}/attrs -o ${ldap.build.dir}/zimbra_defaultcos.ldif" />
    </java>
    <java classname="com.zimbra.cs.account.AttributeManagerUtil" fork="true" classpathref="class.path" failonerror="true">
      <sysproperty key="carbonio.version" value="${carbonio.buildinfo.all}" />
      <arg line="-a generateDefaultExternalCOSLdif -i ${maven.build.dir}/attrs -o ${ldap.build.dir}/zimbra_defaultexternalcos.ldif" />
    </java>
    <copy todir="${ldap.build.dir}/" file="${ldap.conf.dir}/ldap/carbonio.ldif" />
    <copy todir="${ldap.build.dir}/" file="${ldap.conf.dir}/ldap/mimehandlers.ldif" />
    <copy todir="${ldap.build.dir}/schema" file="${ldap.conf.dir}/ldap/amavisd.schema" />
    <copy todir="${ldap.build.dir}/schema" file="${ldap.conf.dir}/ldap/amavisd.ldif" />
    <copy todir="${ldap.build.dir}/schema" file="${ldap.conf.dir}/ldap/opendkim.ldif" />

    <copy todir="${ldap.build.dir}/config" file="${slapd.config.src}" />
    <copy todir="${ldap.build.dir}/config/cn=config" file="${slapd.config.dir}/cn=config/cn=module{0}.ldif" />
    <copy todir="${ldap.build.dir}/config/cn=config" file="${slapd.config.dir}/cn=config/cn=schema.ldif" />
    <copy todir="${ldap.build.dir}/config/cn=config" file="${slapd.config.dir}/cn=config/olcDatabase={0}config.ldif" />
    <copy todir="${ldap.build.dir}/config/cn=config" file="${slapd.config.dir}/cn=config/olcDatabase={-1}frontend.ldif" />
    <copy todir="${ldap.build.dir}/config/cn=config" file="${slapd.config.dir}/cn=config/olcDatabase={1}monitor.ldif" />
    <copy todir="${ldap.build.dir}/config/cn=config/" file="${slapd.config.dir}/cn=config/olcDatabase={2}mdb.ldif" />
    <copy todir="${ldap.build.dir}/config/cn=config/olcDatabase={2}mdb" file="${slapd.config.dir}/cn=config/olcDatabase={2}mdb/olcOverlay={0}dynlist.ldif" />
    <copy todir="${ldap.build.dir}/config/cn=config/olcDatabase={2}mdb" file="${slapd.config.dir}/cn=config/olcDatabase={2}mdb/olcOverlay={1}unique.ldif" />
    <copy todir="${ldap.build.dir}/config/cn=config/olcDatabase={2}mdb" file="${slapd.config.dir}/cn=config/olcDatabase={2}mdb/olcOverlay={2}noopsrch.ldif" />
    <copy todir="${ldap.build.dir}/updates/">
      <fileset dir="${ldap.dir}/src/updates/" includes="**" />
    </copy>

    <!--schema -->

  </target>

</project>
