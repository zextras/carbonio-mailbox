<project name="zm-store">
  <import file="../ant-build-common.xml"/>

  <property name="store-conf.config.dir" location="${basedir}/../store-conf/conf"/>
  <property name="rights.dir" location="${basedir}/src/main/resources/conf/rights"/>

  <!--  TODO: remove unnecessary folder-->
  <target name="build-init" description="Creates directories required for compiling">
    <mkdir dir="${build.classes.dir}"/>
    <mkdir dir="${maven.build.dir}/data"/>
    <mkdir dir="${maven.build.dir}/zimbra"/>
    <mkdir dir="${maven.build.dir}/zimbra/conf"/>
    <mkdir dir="${maven.build.dir}/bin"/>
    <mkdir dir="${maven.build.dir}/conf/attrs"/>
    <mkdir dir="${maven.build.dir}/conf/msgs"/>
    <mkdir dir="${maven.build.dir}/db"/>
    <mkdir dir="${maven.build.dir}/lib/ext"/>
    <mkdir dir="${maven.build.dir}/lib/jars"/>
    <mkdir dir="${maven.build.dir}/lib/jars-ant"/>
    <mkdir dir="${maven.build.dir}/libexec"/>
  </target>

  <target name="generate-buildinfo" depends="build-init, set-dev-version">
    <mkdir dir="${maven.build.dir}/generated-resources/com/zimbra/cs/util"/>
    <echo file="${maven.build.dir}/generated-resources/com/zimbra/cs/util/buildInfo.properties">
      MAJORVERSION=${zimbra.buildinfo.majorversion}
      MINORVERSION=${zimbra.buildinfo.minorversion}
      MICROVERSION=${zimbra.buildinfo.microversion}
      RELCLASS=${zimbra.buildinfo.relclass}
      RELNUM=${zimbra.buildinfo.relnum}
      BUILDNUM=${zimbra.buildinfo.buildnum}
      VERSION=${zimbra.buildinfo.version}
      RELEASE=${zimbra.buildinfo.release}
      DATE=${DSTAMP}-${TSTAMP}
      HOST=${zimbra.buildinfo.host}
    </echo>
  </target>

  <!-- Cleans up store directory and maven build in maven clean phase -->
  <target name="clean">
    <delete dir="${basedir}/build"/>
    <delete dir="${basedir}/tmp"/>
    <delete dir="${maven.build.dir}"/>
  </target>

  <!-- Copies bundle msgs required for test to directory base folder -->
  <target name="copy-msgs-bundle">
    <copy todir="${basedir}/build/zimbra/conf/msgs">
      <fileset dir="${basedir}/../store-conf/conf/msgs"/>
    </copy>
    <copy todir="${basedir}/build/zimbra/conf/" file="${basedir}/../store-conf/conf/log4j.properties"/>
    <copy todir="${basedir}/build/zimbra/conf/" file="${basedir}/../store-conf/conf/antisamy.xml"/>
    <copy todir="${basedir}/build/zimbra/conf/" file="${basedir}/../store-conf/conf/owasp_policy.xml"/>
    <copy todir="${basedir}/build/zimbra/conf/" file="${basedir}/../store-conf/conf/contacts/contact-fields.xml"/>
  </target>

  <target name="create-version-sql" depends="build-init, set-dev-version"
    description="Creates version-init.sql">
    <java classname="com.zimbra.cs.db.MySQL" fork="true" classpath="${maven_compile_classpath}"
      failonerror="true">
      <classpath>
        <pathelement location="${maven.build.dir}/classes"/>
      </classpath>
      <arg line="-o ${maven.build.dir}"/>
    </java>
  </target>

  <!-- Rights generator -->
  <path id="class.path">
    <pathelement path="${maven_compile_classpath}"/>
    <pathelement path="src/main/java"/>
  </path>

  <target name="generate-domainadmin-rights-xml">
    <java classname="com.zimbra.cs.account.accesscontrol.RightManager" classpathref="class.path"  fork="true" failonerror="true">
      <sysproperty key="carbonio.version" value="${carbonio.buildinfo.all}"/>
      <sysproperty key="zimbra.config" value="conf/localconfig-autogen.xml"/>
      <arg line="-a genDomainAdminSetAttrsRights -r ${rights.dir}/rights-domainadmin.xml -t ${rights.dir}/rights-domainadmin.xml-template"/>
    </java>
  </target>

  <target name="generate-rights-java">
    <java classname="com.zimbra.cs.account.accesscontrol.RightManager" fork="true" classpathref="class.path" failonerror="true">
      <sysproperty key="zimbra.config" value="conf/localconfig-autogen.xml"/>
      <sysproperty key="carbonio.version" value="${carbonio.buildinfo.all}"/>
      <arg line="-a genRightConsts -i ${rights.dir} -r
      ${src.java.dir}/com/zimbra/cs/account/accesscontrol/generated/RightConsts.java"/>
    </java>
    <java classname="com.zimbra.cs.account.accesscontrol.RightManager" fork="true" classpathref="class.path" failonerror="true">
      <sysproperty key="zimbra.config" value="conf/localconfig-autogen.xml"/>
      <sysproperty key="carbonio.version" value="${carbonio.buildinfo.all}"/>
      <arg line="-a genAdminRights -i ${rights.dir} -r ${src.java.dir}/com/zimbra/cs/account/accesscontrol/generated/AdminRights.java"/>
    </java>
    <java classname="com.zimbra.cs.account.accesscontrol.RightManager" fork="true" classpathref="class.path" failonerror="true">
      <sysproperty key="zimbra.config" value="conf/localconfig-autogen.xml"/>
      <sysproperty key="carbonio.version" value="${carbonio.buildinfo.all}"/>
      <arg line="-a genUserRights -i ${rights.dir} -r ${src.java.dir}/com/zimbra/cs/account/accesscontrol/generated/UserRights.java"/>
    </java>
  </target>

  <target name="generate-rights-message-properties">
    <java classname="com.zimbra.cs.account.accesscontrol.RightManager" fork="true" classpathref="class.path" failonerror="true">
      <sysproperty key="carbonio.version" value="${carbonio.buildinfo.all}"/>
      <sysproperty key="zimbra.config" value="conf/localconfig-autogen.xml"/>
      <arg line="-a genMessageProperties -i ${rights.dir} -r ${store-conf.config.dir}/msgs/ZsMsgRights.properties"/>
    </java>
  </target>

  <target name="generate-rights">
    <antcall target="generate-domainadmin-rights-xml"/>
    <antcall target="generate-rights-java"/>
    <antcall target="generate-rights-message-properties"/>
  </target>


</project>
