map $http_cookie $auth_token_cookie {
    default       0;
    "~ZM_AUTH_TOKEN="  1;
}

server {
 listen 9000;
 server_name localhost;

location ~ ^/carbonio(/|$) {

         try_files index.html /carbonio/;
         add_header Cache-Control "no-cache,must-revalidate,no-transform,max-age=604800";
         alias /opt/zextras/web/iris/carbonio-shell-ui/current/;
 }
location ~/logout
    {
        add_header Set-Cookie "ZM_AUTH_TOKEN=; Path=/; Expires=Thu, 01-Jan-1970 00:00:00 GMT; Max-Age=0";
        add_header Set-Cookie "ZX_AUTH_TOKEN=; Path=/; Expires=Thu, 01-Jan-1970 00:00:00 GMT; Max-Age=0";
        add_header Set-Cookie "JSESSIONID=; Path=/; Expires=Thu, 01-Jan-1970 00:00:00 GMT; Max-Age=0";
        add_header Set-Cookie "AUTH_TOKEN_TYPE=; Path=/; Expires=Thu, 01-Jan-1970 00:00:00 GMT; Max-Age=0";
        add_header Set-Cookie "T=; Path=/; Expires=Thu, 01-Jan-1970 00:00:00 GMT; Max-Age=0";
        add_header Set-Cookie "Y=; Path=/; Expires=Thu, 01-Jan-1970 00:00:00 GMT; Max-Age=0";
        add_header Set-Cookie "ADMIN_AUTH_KEY=; Path=/; Expires=Thu, 01-Jan-1970 00:00:00 GMT; Max-Age=0";
        return 307 /static/login/;
    }

  location ~/static/(.*) {
    add_header Expect-CT max-age=86400;
    add_header Permissions-Policy "geolocation=(self), microphone=(self)";
    add_header Referrer-Policy "same-origin";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload";
    add_header X-Content-Type-Options "nosniff";
    add_header X-Frame-Options "sameorigin";
    add_header X-Robots-Tag "noindex, nofollow";
    add_header X-XSS-Protection "1; mode=block";
    add_header Content-Security-Policy "default-src 'self' data: blob: cid:; script-src 'self' 'unsafe-inline' 'unsafe-eval' *.zextras.tools *.jsdelivr.net; style-src * 'unsafe-inline'; img-src * data: blob: cid:; font-src * data:; connect-src 'self' *.zextras.tools *.jsdelivr.net; media-src * blob: data: cid:; object-src 'self'; child-src 'self' blob: data: cid:; frame-src 'self' blob: data: cid:; frame-ancestors 'self'; form-action 'self';";
    add_header Cache-Control "no-cache,must-revalidate,no-transform,max-age=604800";
    alias /opt/zextras/web/$1;
  }


 location / {
           # End user session and redirect them to logout URL.
           # Defaults to /static/login/
           # Marked for removal: will be removed in 23.10.0 and logout will be handled at ~/logout
           if ($query_string ~ loginOp=logout) {
               add_header Set-Cookie "ZM_AUTH_TOKEN=; Path=/; Expires=Thu, 01-Jan-1970 00:00:00 GMT; Max-Age=0";
               add_header Set-Cookie "ZX_AUTH_TOKEN=; Path=/; Expires=Thu, 01-Jan-1970 00:00:00 GMT; Max-Age=0";
               add_header Set-Cookie "JSESSIONID=; Path=/; Expires=Thu, 01-Jan-1970 00:00:00 GMT; Max-Age=0";
               add_header Set-Cookie "AUTH_TOKEN_TYPE=; Path=/; Expires=Thu, 01-Jan-1970 00:00:00 GMT; Max-Age=0";
               add_header Set-Cookie "T=; Path=/; Expires=Thu, 01-Jan-1970 00:00:00 GMT; Max-Age=0";
               add_header Set-Cookie "Y=; Path=/; Expires=Thu, 01-Jan-1970 00:00:00 GMT; Max-Age=0";
               add_header Set-Cookie "ADMIN_AUTH_KEY=; Path=/; Expires=Thu, 01-Jan-1970 00:00:00 GMT; Max-Age=0";
               return 307 /static/login/;
           }

           # Redirect user to login URL.
           # Defaults to /static/login/
           if ($auth_token_cookie = 0) {
             return 307 /static/login/;
           }
  }
  location ~* /(service|principals|dav|\.well-known|home|shf|user|certauth|spnegoauth)/
      {
          # Memcached poisoning with unauthenticated request
          if ($request_uri ~* "%0A|%0D") {
              return 403;
          }

          # Begin stray redirect hack
          #
          # In some cases, we may get a stray redirect out of the mailhost,
          # which attempts to send us to $host:$mailhostport, where:
          #
          # $host is the host portion (excluding port) of the proxy URL
          # $mailhostport is the zimbraMailPort as applies to the mailhost
          #   server being redirected to
          #
          # This is the case when one mailhost in the upstream cluster is
          # trying to redirect to another mailhost in the same cluster
          # In this case, we need to trap and fudge this location header
          #
          # NOTE that this will only work in the cases where each mailhost
          # within the cluster has the same mailhostport (Limitation)
          #

          set $mailhostport 8080;   # replace this with *the* mailhost port
          set $relhost $host;

          if ($mailhostport != 80) {   # standard HTTP port, do not replace
              set $relhost $host:$mailhostport;
          }

          # End stray redirect hack

          # Proxy to Zimbra Mailbox Upstream
          proxy_pass       http://localhost:8080;

          # For audit
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

          proxy_set_header X-Forwarded-Proto $scheme;
  }

}